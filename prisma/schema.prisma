// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Company {
  id                String   @id @default(cuid())
  name              String
  nameNormalized    String   @default("")  // Normalized name for fast search
  registrationNumber String  @unique
  registrationNumberNormalized String  @default("")  // Normalized registration number for search
  taxNumber         String   @unique
  taxNumberNormalized String  @default("")  // Normalized tax number for search
  legalAddress      String
  registrationDate  DateTime
  phone             String?
  email             String?

  // Business Status & Capital
  status                      String    @default("Aktīvs")
  legalForm                   String?   // e.g., "Sabiedrība ar ierobežotu atbildību"
  registryName                String?   // e.g., "Komercreģistrs"
  shareCapital                Float?    // in EUR
  shareCapitalRegisteredDate  DateTime?
  registeredVehiclesCount     Int?      // CSDD data

  // Risk & Compliance Information
  hasEncumbrances        Boolean   @default(false)
  inLiquidation          Boolean   @default(false)
  inInsolvencyRegister   Boolean   @default(false)
  hasPaymentClaims       Boolean   @default(false)
  hasCommercialPledges   Boolean   @default(false)
  hasSecurities          Boolean   @default(false)
  hasTaxDebts            Boolean   @default(false)
  taxDebtsCheckedDate    DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  owners            Ownership[]
  boardMembers      BoardMember[]
  beneficialOwners  BeneficialOwner[]
  taxPayments       TaxPayment[]
  financialRatios   FinancialRatio[]

  @@index([name])
  @@index([nameNormalized])
  @@index([registrationNumber])
  @@index([taxNumber])
}

model Owner {
  id           String   @id @default(cuid())
  name         String
  personalCode String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  companies    Ownership[]

  @@index([name])
}

model Ownership {
  id              String   @id @default(cuid())
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId       String
  owner           Owner    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId         String

  // Share Details
  sharePercentage Float
  sharesCount     Int?      // Number of shares
  nominalValue    Float?    // Nominal value per share in EUR
  totalValue      Float?    // Total value in EUR
  votingRights    Float?    // Voting rights from shares
  memberSince     DateTime? // Date joined as member
  notes           String?   // Additional notes
  isHistorical    Boolean   @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([companyId, ownerId])
  @@index([companyId])
  @@index([ownerId])
  @@index([isHistorical])
  @@index([companyId, isHistorical])
}

model TaxPayment {
  id        String   @id @default(cuid())
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String
  year      Int
  amount    Float
  date      DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([year])
  @@index([companyId, year])
}

model FinancialRatio {
  id                      String   @id @default(cuid())
  company                 Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId               String
  year                    Int

  // Profitability Ratios
  returnOnEquity          Float?   // ROE - Net Income / Shareholder's Equity
  returnOnAssets          Float?   // ROA - Net Income / Total Assets
  roce                    Float?   // ROCE - EBIT / Capital Employed
  netProfitMargin         Float?   // Net Income / Revenue
  grossProfitMargin       Float?   // Gross Profit / Revenue
  operatingProfitMargin   Float?   // Operating Income / Revenue (EBIT Margin)
  ebitdaMargin            Float?   // EBITDA / Revenue
  cashFlowMargin          Float?   // Operating Cash Flow / Revenue
  revenuePerEmployee      Float?   // Revenue / Number of Employees
  profitPerEmployee       Float?   // Net Profit / Number of Employees

  // Liquidity Ratios
  currentRatio            Float?   // Current Assets / Current Liabilities
  quickRatio              Float?   // (Current Assets - Inventory) / Current Liabilities
  cashRatio               Float?   // Cash & Cash Equivalents / Current Liabilities
  workingCapitalRatio     Float?   // Working Capital / Total Assets

  // Leverage Ratios
  debtToEquity            Float?   // Total Debt / Total Equity
  debtRatio               Float?   // Total Debt / Total Assets
  interestCoverageRatio   Float?   // EBIT / Interest Expense
  equityMultiplier        Float?   // Total Assets / Total Equity

  // Efficiency Ratios
  assetTurnover           Float?   // Revenue / Total Assets
  inventoryTurnover       Float?   // Cost of Goods Sold / Average Inventory
  receivablesTurnover     Float?   // Revenue / Average Accounts Receivable
  payablesTurnover        Float?   // COGS / Average Accounts Payable
  dso                     Float?   // Days Sales Outstanding (365 / Receivables Turnover)
  dpo                     Float?   // Days Payable Outstanding (365 / Payables Turnover)
  cashConversionCycle     Float?   // Days Inventory + Days Receivables - Days Payables

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@unique([companyId, year])
  @@index([companyId])
  @@index([year])
}

model BoardMember {
  id                  String    @id @default(cuid())
  company             Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId           String
  name                String
  personalCode        String?
  institution         String?   // e.g., "Valde"
  position            String?   // e.g., "Valdes priekšsēdētājs"
  appointedDate       DateTime?
  representationRights String?  // e.g., "Tiesības pārstāvēt atsevišķi"
  notes               String?
  isHistorical        Boolean   @default(false)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([companyId])
  @@index([isHistorical])
  @@index([companyId, isHistorical])
}

model BeneficialOwner {
  id                String    @id @default(cuid())
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId         String
  name              String
  personalCode      String?
  dateFrom          DateTime?
  residenceCountry  String?
  citizenship       String?
  controlType       String?   // e.g., "kā dalībnieks"
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([companyId])
}

// ============================================
// USER AUTHENTICATION MODELS (NextAuth.js v5)
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // Hashed password for credentials provider
  role          UserRole  @default(USER)
  isActive      Boolean   @default(true)
  locale        String    @default("lv")  // User's preferred language (lv, en)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // NextAuth.js required relations
  accounts      Account[]
  sessions      Session[]

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  id         String    @id @default(cuid())
  identifier String    // Email address
  token      String    @unique
  expires    DateTime
  type       TokenType @default(EMAIL_VERIFICATION)
  createdAt  DateTime  @default(now())

  @@unique([identifier, token])
  @@index([identifier])
  @@index([token])
  @@index([token, type, expires])
}

// Enums
enum UserRole {
  USER
  ADMIN
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}
